{% extends 'base.html' %} {% block title %}T·∫°o B√†i ƒêƒÉng{% endblock %}
<!--  -->

{% block extra_css %}

<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/post.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/color.css') }}"
/>
{% endblock %}

<!--  -->
{% block content %}

<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
  <a class="navbar-brand" href="{{ url_for('home.homepage') }}">
    <img
      src="{{ url_for('static', filename='image/home.png') }}"
      style="width: 30px"
      alt="home image"
    />
  </a>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('home.homepage') }}">Home</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="{{ url_for('post.create_post') }}"
          >Create Post</a
        >
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('post.my_posts') }}">My Post</a>
      </li>
    </ul>
  </div>
</nav>

<div
  id="page-wrapper"
  data-success="{{ '1' if success_message else '0' }}"
  class="khung-ngoai"
>
  <!-- LEFT COLUMN -->

  <div class="col-md-6">
    <div class="form-section">
      <h2 style="font-weight: bold">B√†i ƒëƒÉng m·ªõi</h2>
      
      <hr
        style="
          border: none;
          height: 2px;
          background-color: gray;
          margin: 20px 0;
        "
      />
      <!-- Hi·ªÉn th·ªã th√¥ng b√°o flash -->
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %} {% endif %} {% endwith %}
      <div class="user-info">
        <img
          src="{{user.avatar}}"
          alt="Avatar"
          width="50px"
          class="avatar-user-info"
          style="border: 1px solid black"
        />
        <!-- "{{ user.avatar_url }}"  -->
        <div style="font-size: 30px; font-weight: bold; color: #1c5d39">
          {{ user.fullname }}
        </div>
      </div>
      <form method="POST" enctype="multipart/form-data">
        <div class="form-group mt-3">
          <label for="category">Ch·ªçn danh m·ª•c</label>
          <select
            name="category"
            id="category"
            class="form-control"
            required
            style="border: 2px solid black; background-color: var(--mau14)"
          >
            <option value="">-- Ch·ªçn danh m·ª•c --</option>
            {% for c in categories %}
            <option value="{{ c.id }}">{{ c.category_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="post_type">Ch·ªçn lo·∫°i b√†i ƒëƒÉng</label>
          <select
            name="post_type"
            id="post_type"
            class="form-control"
            required
            style="border: 2px solid black; background-color: var(--mau14)"
          >
            <option value="">-- Ch·ªçn lo·∫°i --</option>
            <option value="thanh_ly">Thanh l√Ω</option>
            <option value="trao_doi">Trao ƒë·ªïi</option>
            <option value="donate">Donate</option>
          </select>
        </div>

        <div class="form-group mt-3">
          <label for="content">N·ªôi dung b√†i vi·∫øt</label>
          <textarea
            name="content"
            id="content"
            class="form-control"
            rows="4"
            placeholder="Nh·∫≠p n·ªôi dung..."
            required
            style="border: 2px solid black; background-color: var(--mau14)"
          ></textarea>
        </div>

        <div class="form-group mt-3">
          <label for="images">Ch·ªçn ·∫£nh</label>
          <input
            type="file"
            name="images"
            id="images"
            multiple
            accept="image/*"
            class="form-control"
            style="border: 2px solid black; background-color: var(--mau14)"
          />
        </div>
        <!-- Tr∆∞·ªùng ch·ªâ hi·ªÉn th·ªã khi ch·ªçn Thanh l√Ω -->
        <div id="price_group" class="form-group mt-3" style="display: none">
          <label for="price">Gi√°</label>
          <input
            type="number"
            name="price"
            id="price"
            class="form-control"
            placeholder="Nh·∫≠p gi√°..."
            style="border: 2px solid black; background-color: var(--mau14)"
          />
        </div>
        <!-- Tr∆∞·ªùng contact -->
        <div id="contact_group" class="form-group mt-3" style="display: none">
          <div style="display: flex">
            <p for="contact" style="font-weight: bold">Th√¥ng tin li√™n h·ªá</p>
            <p id="statusMessage" style="margin-left: 20px"></p>
          </div>
          <div class="container-input" style="display: flex; gap: 10px">
            <div class="input-label" style="flex: 2">
              
                <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                
              

              <input
                type="text"
                name="phone"
                id="phone"
                class="form-control"
                value="{{user.phone}}"
                required
                style="border: 2px solid black; background-color: var(--mau14)"
              />
            </div>
            <div class="input-submit" style="margin-top: 13px; flex: 1">
              <a
                href="{{url_for('post.remember_phone')}}"
                id="phoneID"
                value="{{ user.phone }}"
                class="btn btn-primary mt-4 w-100"
                style="background-color: var(--mau4); font-weight: bold"
                >Remember Phone</a
              >
            </div>
          </div>

          <div class="container-input" style="display: flex; gap: 10px">
            <div class="input-label" style="flex: 2">
              <div style="display: flex">
                <label for="email">Email</label>
                <p id="statusMessage" style="margin-left: 20px"></p>
              </div>

              <input
                type="email"
                name="email"
                id="email"
                class="form-control"
                value="{{user.email}}"
                required
                style="border: 2px solid black; background-color: var(--mau14)"
              />
            </div>
            <div class="input-submit" style="margin-top: 13px; flex: 1">
              <a
                href="{{url_for('post.remember_email')}}"
                id="emailID"
                value="{{ user.email }}"
                class="btn btn-primary mt-4 w-100"
                style="background-color: var(--mau4); font-weight: bold"
                >Remember Email</a
              >
            </div>
          </div>
          <div class="container-input" style="display: flex; gap: 10px">
            <div class="input-label" style="flex: 2">
              <div style="display: flex">
                <label for="facebook">Facebook</label>
                <p id="statusMessage" style="margin-left: 20px"></p>
              </div>

              <input
                type="facebook"
                name="facebook"
                id="facebook"
                class="form-control"
                value="{{user.facebook}}"
                required
                style="border: 2px solid black; background-color: var(--mau14)"
              />
            </div>
            <div class="input-submit" style="margin-top: 13px; flex: 1">
              <a
                href="{{url_for('post.remember_facebook')}}"
                id="facebookID"
                value="{{ user.facebook }}"
                class="btn btn-primary mt-4 w-100"
                style="background-color: var(--mau4); font-weight: bold"
                >Remember Facebook</a
              >
            </div>
          </div>
          
          
          </div>
        
        <div id="preview" class="row mt-3"></div>

        <button
          type="submit"
          class="btn btn-primary mt-4 w-100"
          style="background-color: var(--mau4); font-weight: bold"
        >
          ƒêƒÉng b√†i
        </button>
        
      </form>
      
    </div>
    </div>
  

  <!-- RIGHT COLUMN -->
  <div class="col-md-6">
    <div class="preview-section">
      <h2 style="font-weight: bold">Preview</h2>
      <p class="text-muted">
        Xem tr∆∞·ªõc b√†i ƒëƒÉng c·ªßa b·∫°n tr∆∞·ªõc khi ƒëƒÉng ch√≠nh th·ª©c.
      </p>
      <hr
        style="
          border: none;
          height: 2px;
          background-color: gray;
          margin: 20px 0;
        "
      />
      <div id="postPreview" class="border p-3 rounded bg-light">
        <div class="d-flex align-items-center mb-2">
          <img
            src="{{user.avatar}}"
            class="rounded-circle me-2"
            style="width: 40px; margin-right: 10px"
          />
          <strong>{{user.fullname}}</strong>
        </div>
        <!-- <p id="previewContent" class="preview-caption"></p> -->
        <div
          id="previewContainer"
          class="preview-container"
          style="font-weight: bold"
        >
          <p>
            Danh m·ª•c:
            <span id="category-name-preview" style="font-weight: normal"
              >Ch∆∞a ch·ªçn</span
            >
          </p>
          <!--preview danh m·ª•c-->
          <p>
            Lo·∫°i b√†i ƒëƒÉng:
            <span id="post-type-preview" style="font-weight: normal"></span>
          </p>
          <p>
            N·ªôi dung: <br />
            <span id="content-preview" style="font-weight: normal"></span>
          </p>
          <p><span id="price-preview" style="font-weight: normal"></span></p>
          <p>
            Th√¥ng tin li√™n h·ªá:<br>
            <span id="phone-preview" style="font-weight: normal"></span> <br>
            <span id="email-preview" style="font-weight: normal"></span> <br>
            <span id="facebook-preview" style="font-weight: normal"></span> 
          </p>
        </div>

        <div
          id="previewImageContainer"
          class="mb-2"
          style="margin-top: 20px"
        ></div>
      </div>
    </div>
  </div>
</div>
</div>
{% if success_message %}
<div
  class="modal fade"
  id="successModal"
  tabindex="-1"
  aria-labelledby="successModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      {% if user_role == 'admin' %}
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">üéâ ƒêƒÉng b√†i th√†nh c√¥ng</h5>
      </div>
      {% else %}
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">‚è≥ G·ª≠i b√†i th√†nh c√¥ng</h5>
      </div>
      {% endif %}
      <div class="modal-body">{{ success_message }}</div>
      <div class="modal-footer">
        <a href="{{ url_for('post.view_posts') }}" class="btn btn-primary"
          >OK</a
        >
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  const input = document.getElementById("images");
  const preview = document.getElementById("preview");
  const previewImageContainer = document.getElementById(
    "previewImageContainer"
  );
  const previewContent = document.getElementById("previewContent");
  const contentInput = document.getElementById("content");
  let files = [];

  input.addEventListener("change", function () {
    preview.innerHTML = "";
    files = Array.from(this.files);
    previewImageContainer.innerHTML = "";

    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = document.createElement("img");
        img.src = e.target.result;
        previewImageContainer.appendChild(img);

        const col = document.createElement("div");
        col.classList.add("col-md-3", "mb-3");
        col.innerHTML = `
          <div class="card">
            <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
            <div class="card-body p-2 text-center">
              <button type="button" class="btn btn-sm btn-danger btn-block remove-btn" data-index="${index}">X√≥a</button>
            </div>
          </div>`;
        preview.appendChild(col);
      };
      reader.readAsDataURL(file);
    });
  });

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-btn")) {
      const index = parseInt(e.target.getAttribute("data-index"));
      files.splice(index, 1);
      const dataTransfer = new DataTransfer();
      files.forEach((f) => dataTransfer.items.add(f));
      input.files = dataTransfer.files;
      input.dispatchEvent(new Event("change"));
    }
  });

  contentInput.addEventListener("input", function () {
    previewContent.textContent = contentInput.value;
  });

  const postTypeSelect = document.getElementById("post_type");
  const priceGroup = document.getElementById("price_group");
  const contactGroup = document.getElementById("contact_group");

  postTypeSelect.addEventListener("change", function () {
    const type = this.value;
    priceGroup.style.display = "none";
    contactGroup.style.display = "none";

    if (type === "thanh_ly") {
      priceGroup.style.display = "block";
      contactGroup.style.display = "block";
    } else if (type === "trao_doi" || type === "donate") {
      contactGroup.style.display = "block";
    }
  });

  const wrapper = document.getElementById("page-wrapper");
  if (wrapper.dataset.success === "1") {
    const modal = new bootstrap.Modal(document.getElementById("successModal"));
    modal.show();
  }

  // preview category
  function updateCategoryName() {
    const select = document.getElementById("category");
    const selectedOption = select.options[select.selectedIndex];
    let categoryName = "Ch∆∞a ch·ªçn"; // Gi√° tr·ªã m·∫∑c ƒë·ªãnh

    // Ki·ªÉm tra xem selectedOption c√≥ t·ªìn t·∫°i v√† c√≥ gi√° tr·ªã (value) kh√¥ng r·ªóng kh√¥ng
    // Option "-- Ch·ªçn danh m·ª•c --" c√≥ value=""
    if (selectedOption && selectedOption.value) {
      categoryName = selectedOption.textContent;
    } else {
      // N·∫øu gi√° tr·ªã r·ªóng (nghƒ©a l√† ƒëang ch·ªçn "-- Ch·ªçn danh m·ª•c --")
      // th√¨ v·∫´n gi·ªØ l√† ch∆∞a ch·ªçn
      categoryName = "Ch∆∞a ch·ªçn";
    }
    document.getElementById("category-name-preview").textContent = categoryName;
  }

  document.addEventListener("DOMContentLoaded", function () {
    updateCategoryName(); // g·ªçi l·∫ßn ƒë·∫ßu ƒë·ªÉ thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu
    document
      .getElementById("category")
      .addEventListener("change", updateCategoryName);
  });
  //preview content
  function updateContent() {
    const content = document.getElementById("content").value;
    const formatted = content.replace(/\n/g, "<br>");
    document.getElementById("content-preview").innerHTML = formatted;
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("content").addEventListener("input", updateContent);
  });

  // preview post type
  function updatePostType() {
    const select = document.getElementById("post_type");
    const selectedOption = select.options[select.selectedIndex];

    const postTypePreview = document.getElementById("post-type-preview");
    const priceId = document.getElementById("price");
    const pricePreview = document.getElementById("price-preview");
    // L·∫•y th·∫ª cha c·ªßa price-preview ƒë·ªÉ ·∫©n/hi·ªán c·∫£ d√≤ng "Gi√°:"
    const pricePreviewContainer = document.getElementById("previewContainer");
    const post_type_Text = selectedOption.textContent.trim();

    postTypePreview.textContent = post_type_Text;

    // Ki·ªÉm tra n·∫øu lo·∫°i b√†i ƒëƒÉng l√† "thanh_ly"
    if (post_type_Text === "Thanh l√Ω") {
      const priceValue = priceId.value;
      pricePreview.textContent = "Gi√°: " + priceValue + " VNƒê";
      // pricePreviewContainer.style.display = ""; // Hi·ªÉn th·ªã d√≤ng ch·ª©a gi√°
    } else {
      pricePreview.textContent = ""; // X√≥a n·ªôi dung gi√°
      // pricePreviewContainer.style.display = "none"; // ·∫®n d√≤ng ch·ª©a gi√°
    }
  }
  document.addEventListener("DOMContentLoaded", function () {
    const postTypeSelect = document.getElementById("post_type");
    const priceInput = document.getElementById("price");
    if (postTypeSelect) {
      postTypeSelect.addEventListener("change", updatePostType);
    } else {
      console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ select 'post_type'.");
    }

    if (priceInput) {
      // S·ª≠ d·ª•ng s·ª± ki·ªán 'input' ƒë·ªÉ c·∫≠p nh·∫≠t ngay khi ng∆∞·ªùi d√πng g√µ gi√°
      priceInput.addEventListener("input", updatePostType);
    } else {
      console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ input 'price'.");
    }

    // G·ªçi h√†m l·∫ßn ƒë·∫ßu ƒë·ªÉ thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu d·ª±a tr√™n l·ª±a ch·ªçn m·∫∑c ƒë·ªãnh
    updatePostType();
  });

  //preview content
  function updateContact() {
    const phone = document.getElementById("phone").value;
    const email = document.getElementById("email").value;
    const facebook = document.getElementById("facebook").value;
    document.getElementById("phone-preview").textContent = phone;
    document.getElementById("email-preview").textContent = email;
    document.getElementById("facebook-preview").textContent = facebook;
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("phone").addEventListener("input", updateContact);
    document.getElementById("email").addEventListener("input", updateContact);
    document
      .getElementById("facebook")
      .addEventListener("input", updateContact);

    updateContact();
  });

  document.getElementById("phoneID").addEventListener("click", function (e) {
    e.preventDefault();
    var phone = document.getElementById("phone").value;

    fetch("/remember-phone", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ phone: phone }),
    })
      .then((response) => response.json())
      .then((data) => {
        var statusEl = document.getElementById("statusMessage");
        if (data.status === "success") {
          statusEl.textContent = "ƒê√£ l∆∞u th√†nh c√¥ng!";
          statusEl.style.color = "green";
        } else {
          statusEl.textContent = "L·ªói: " + data.message;
          statusEl.style.color = "red";
        }
        // X√≥a message sau 5 gi√¢y
        setTimeout(() => {
        statusEl.textContent = "";
      }, 5000);
      })
      .catch((error) => {
        document.getElementById("statusMessage").textContent = "L·ªói khi l∆∞u!";
        document.getElementById("statusMessage").style.color = "red";
        // X√≥a message sau 5 gi√¢y
        setTimeout(() => {
        statusEl.textContent = "";
      }, 5000);
      });
  });



  document.getElementById("emailID").addEventListener("click", function (e) {
    e.preventDefault();
    var email = document.getElementById("email").value;

    fetch("/remember-email", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ email: email }),
    })
      .then((response) => response.json())
      .then((data) => {
        var statusEl = document.getElementById("statusMessage");
        if (data.status === "success") {
          statusEl.textContent = "ƒê√£ l∆∞u th√†nh c√¥ng!";
          statusEl.style.color = "orange";
        } else {
          statusEl.textContent = "L·ªói: " + data.message;
          statusEl.style.color = "red";
        }
        // X√≥a message sau 5 gi√¢y
        setTimeout(() => {
        statusEl.textContent = "";
      }, 5000);
      })
      .catch((error) => {
        document.getElementById("statusMessage").textContent = "L·ªói khi l∆∞u!";
        document.getElementById("statusMessage").style.color = "red";
        // X√≥a message sau 5 gi√¢y
        setTimeout(() => {
        statusEl.textContent = "";
      }, 5000);
      });
  });

  
  document.getElementById("facebookID").addEventListener("click", function (e) {
    e.preventDefault();
    var facebook = document.getElementById("facebook").value;

    fetch("/remember-facebook", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ facebook: facebook }),
    })
      .then((response) => response.json())
      .then((data) => {
        var statusEl = document.getElementById("statusMessage");
        if (data.status === "success") {
          statusEl.textContent = "ƒê√£ l∆∞u th√†nh c√¥ng!";
          statusEl.style.color = "blue";
        } else {
          statusEl.textContent = "L·ªói: " + data.message;
          statusEl.style.color = "red";
        }
        // X√≥a message sau 5 gi√¢y
        setTimeout(() => {
        statusEl.textContent = "";
      }, 5000);
      })

      
      .catch((error) => {
        document.getElementById("statusMessage").textContent = "L·ªói khi l∆∞u!";
        document.getElementById("statusMessage").style.color = "red";
        // X√≥a message sau 5 gi√¢y
        setTimeout(() => {
        statusEl.textContent = "";
      }, 8000);
      });
  });
</script>

{% endblock %}
